<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>Unit Testing Sds/IdentityModule/IdentityController</title>
		<style type="text/css">
            @import "../../themes/bootstrap/css/bootstrap.css";
            @import "../../themes/bootstrap/css/bootstrap-responsive.css";
		</style>
        <script type="text/javascript" src="../testconfig.js"></script>
        <script type="text/javascript">
            dojoConfig.mergeConfigs.push('Sds/Test/IdentityModule/Asset/config');
        </script>
        <script type="text/javascript" src="../../../dojo/dojo.js"></script>
		<script type="text/javascript">
			require([
                'doh/main',
                'dojo/when',
                'get!Sds/IdentityModule/IdentityController',
                'get!Sds/IdentityModule/View/CreateIdentity',
                'get!Sds/Store/storeManager',
                'dojo/domReady!'
            ],
            function(
                doh,
                when,
                identityController,
                mockCreateIdentityView,
                storeManager
            ){

                //Modify the prototype for testing so the store doesn't send a real xhr request
                var storeIdentity;
                var proto = storeManager.getStore('Identity').__proto__;
                while (true){
                    if (proto.declaredClass == 'dojo.store.JsonRest'){
                        proto.get = function(id){
                            if (id == 'lucy'){
                                return storeIdentity;
                            } else {
                                return;
                            }
                        }
                        proto.put = function(data){
                            storeIdentity = data;
                        }
                        break;
                    }
                    proto = proto.__proto__
                }

                // Define and register the tests
                doh.register([

                    function testRegisterSucceed(){

                        var testResult = new doh.Deferred;

                        var identity = {
                            identityName: 'lucy',
                            credential: 'password1',
                            firstname: 'Lucy',
                            lastname: 'R',
                            email: 'lucy@awesome.com'
                        };

                        mockCreateIdentityView.value = identity;

                        when(identityController.register(), function(){
                            var identityStore = storeManager.getStore('Identity');

                            var registeredIdentity = identityStore.get('lucy');
                            doh.assertEqual(identity.firstname, registeredIdentity.firstname);
                            doh.assertEqual(identity.lastname, registeredIdentity.lastname);
                            testResult.callback(true);
                        });

                        return testResult;
                    },

                    function testRegisterFail(){

                        var testResult = new doh.Deferred;

                        var identity = {
                            identityName: 'lucy',
                            credential: 'password1',
                            firstname: 'Lucy',
                            lastname: 'R',
                            email: 'badly formed email'
                        };

                        mockCreateIdentityView.value = identity;

                        when(
                            identityController.register(),
                            null,
                            function (exception){
                                doh.assertEqual('InvalidArgumentException', exception.name);
                                testResult.callback(true);
                            }
                        );

                        return testResult;
                    }
                ]);

                // Kick off the test runner
                doh.runOnLoad();
            })
		</script>
	</head>
	<body>
        <h1>Unit Testing Sds/IdentityModule/IdentityController</h1>
	</body>
</html>
